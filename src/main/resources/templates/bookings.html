<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Bookings - Movie Ticket Booking System</title>
    <link rel="stylesheet" href="/css/style.css">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header class="header">
            <div class="header-content">
                <h1><i class="fas fa-film"></i> Movie Ticket Booking System</h1>
                <p>Manage your movie ticket bookings</p>
            </div>
        </header>

        <!-- Navigation -->
        <nav class="nav">
            <ul class="nav-links">
                <li><a href="/"><i class="fas fa-home"></i> Home</a></li>
                <li><a href="/movies"><i class="fas fa-film"></i> Movies</a></li>
                <li><a href="/booking"><i class="fas fa-ticket-alt"></i> Book Tickets</a></li>
                <li><a href="/bookings" class="active"><i class="fas fa-list"></i> My Bookings</a></li>
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Page Header -->
            <section class="page-header">
                <h2><i class="fas fa-list"></i> My Bookings</h2>
                <p>View and manage all your ticket bookings</p>
            </section>

            <!-- Search and Filter Section -->
            <section class="search-section">
                <div class="search-controls">
                    <div class="search-group">
                        <label for="customerSearch">Search by Customer Name:</label>
                        <div class="search-input-group">
                            <input type="text" id="customerSearch" placeholder="Enter customer name...">
                            <button class="btn btn-primary" onclick="searchBookings()">
                                <i class="fas fa-search"></i> Search
                            </button>
                        </div>
                    </div>
                    <div class="filter-group">
                        <button class="btn btn-secondary" onclick="showAllBookings()">
                            <i class="fas fa-list"></i> Show All Bookings
                        </button>
                        <button class="btn btn-info" onclick="refreshBookings()">
                            <i class="fas fa-sync-alt"></i> Refresh
                        </button>
                    </div>
                </div>
            </section>

            <!-- Bookings Section -->
            <section class="bookings-section">
                <div class="bookings-container">
                    <!-- Loading State -->
                    <div id="loadingState" class="loading-state">
                        <div class="loading-spinner">
                            <i class="fas fa-spinner fa-spin"></i>
                        </div>
                        <p>Loading your bookings...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="emptyState" class="empty-state" style="display: none;">
                        <div class="empty-icon">
                            <i class="fas fa-ticket-alt"></i>
                        </div>
                        <h3>No Bookings Found</h3>
                        <p>You don't have any bookings yet. Book your first movie ticket!</p>
                        <a href="/booking" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Book Your First Ticket
                        </a>
                    </div>

                    <!-- Bookings List -->
                    <div id="bookingsList" class="bookings-list" style="display: none;">
                        <!-- Bookings will be populated here -->
                    </div>

                    <!-- Statistics Section -->
                    <div id="statisticsSection" class="statistics-section" style="display: none;">
                        <h3><i class="fas fa-chart-bar"></i> Booking Statistics</h3>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-ticket-alt"></i>
                                </div>
                                <div class="stat-info">
                                    <h4 id="totalBookings">0</h4>
                                    <p>Total Bookings</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-couch"></i>
                                </div>
                                <div class="stat-info">
                                    <h4 id="totalSeats">0</h4>
                                    <p>Total Seats Booked</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-info">
                                    <h4 id="totalSpent">‚Çπ0.00</h4>
                                    <p>Total Amount Spent</p>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-film"></i>
                                </div>
                                <div class="stat-info">
                                    <h4 id="uniqueMovies">0</h4>
                                    <p>Unique Movies</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Quick Actions -->
            <section class="quick-actions">
                <h3><i class="fas fa-bolt"></i> Quick Actions</h3>
                <div class="action-buttons">
                    <a href="/booking" class="btn btn-primary">
                        <i class="fas fa-plus"></i> Book New Ticket
                    </a>
                    <a href="/movies" class="btn btn-secondary">
                        <i class="fas fa-film"></i> Browse Movies
                    </a>
                    <button class="btn btn-info" onclick="exportBookings()">
                        <i class="fas fa-download"></i> Export Bookings
                    </button>
                </div>
            </section>
        </main>

        <!-- Footer -->
        <footer class="footer">
            <div class="footer-content">
                <p>&copy; 2025 Movie Ticket Booking System. Made with ‚ù§Ô∏è for movie lovers!</p>
                <div class="footer-links">
                    <a href="#"><i class="fas fa-info-circle"></i> About</a>
                    <a href="#"><i class="fas fa-envelope"></i> Contact</a>
                    <a href="#"><i class="fas fa-question-circle"></i> Help</a>
                </div>
            </div>
        </footer>
    </div>

    <!-- Booking Details Modal -->
    <div id="bookingModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3><i class="fas fa-ticket-alt"></i> Booking Details</h3>
                <span class="close-modal" onclick="closeModal()">&times;</span>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- Booking details will be populated here -->
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
                <button class="btn btn-primary" onclick="printBooking()" id="printButton">
                    <i class="fas fa-print"></i> Print Ticket
                </button>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="/js/app.js"></script>
    <script>
        let allBookings = [];
        let filteredBookings = [];
        let currentBookingForModal = null;

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            loadBookings();
        });

        // Load all bookings
        async function loadBookings() {
            try {
                showLoadingState();
                const response = await fetch('/api/bookings');
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                allBookings = await response.json();
                filteredBookings = [...allBookings];
                
                if (allBookings.length === 0) {
                    showEmptyState();
                } else {
                    displayBookings(allBookings);
                    updateStatistics(allBookings);
                    showBookingsList();
                }
                
            } catch (error) {
                console.error('Error loading bookings:', error);
                showErrorState('Failed to load bookings. Please refresh the page.');
            }
        }

        // Display bookings
        function displayBookings(bookings) {
            const container = document.getElementById('bookingsList');
            
            if (bookings.length === 0) {
                container.innerHTML = `
                    <div class="no-results">
                        <i class="fas fa-search"></i>
                        <h3>No bookings found</h3>
                        <p>No bookings match your search criteria.</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = bookings.map(booking => {
                const seatText = booking.seats && booking.seats.length > 0 ? 
                    booking.seats.join(', ') : 'No seats specified';
                
                return `
                    <div class="booking-card" onclick="showBookingDetails(${booking.id})">
                        <div class="booking-header">
                            <div class="booking-id">
                                <i class="fas fa-hashtag"></i>
                                Booking #${booking.id}
                            </div>
                            <div class="booking-status">
                                <span class="status-badge confirmed">Confirmed</span>
                            </div>
                        </div>
                        
                        <div class="booking-content">
                            <div class="booking-main-info">
                                <h4 class="movie-title">
                                    <i class="fas fa-film"></i>
                                    ${escapeHtml(booking.movieTitle || 'Unknown Movie')}
                                </h4>
                                
                                <div class="booking-details">
                                    <div class="detail-item">
                                        <i class="fas fa-user"></i>
                                        <span>Customer: ${escapeHtml(booking.customerName || 'Unknown')}</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <i class="fas fa-clock"></i>
                                        <span>Show: ${escapeHtml(booking.showTime || 'Not specified')}</span>
                                    </div>
                                    
                                    <div class="detail-item">
                                        <i class="fas fa-couch"></i>
                                        <span>Seats: ${seatText}</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="booking-price">
                                <div class="price-label">Total Amount</div>
                                <div class="price-value">
                                    ‚Çπ${(booking.totalPrice || 0).toFixed(2)}
                                </div>
                            </div>
                        </div>
                        
                        <div class="booking-footer">
                            <div class="seat-count">
                                ${booking.seats ? booking.seats.length : 0} 
                                ${booking.seats && booking.seats.length === 1 ? 'ticket' : 'tickets'}
                            </div>
                            <div class="booking-actions">
                                <span class="view-details">Click to view details <i class="fas fa-arrow-right"></i></span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Search functionality
        function searchBookings() {
            const searchTerm = document.getElementById('customerSearch').value.toLowerCase().trim();
            
            if (!searchTerm) {
                showAllBookings();
                return;
            }
            
            filteredBookings = allBookings.filter(booking => 
                (booking.customerName || '').toLowerCase().includes(searchTerm) ||
                (booking.movieTitle || '').toLowerCase().includes(searchTerm)
            );
            
            displayBookings(filteredBookings);
            updateStatistics(filteredBookings);
            
            // Update search info
            if (filteredBookings.length !== allBookings.length) {
                const infoEl = document.querySelector('.search-info') || createSearchInfo();
                infoEl.textContent = `Showing ${filteredBookings.length} of ${allBookings.length} bookings`;
            }
        }

        function createSearchInfo() {
            const infoEl = document.createElement('div');
            infoEl.className = 'search-info';
            document.querySelector('.bookings-section').insertBefore(infoEl, document.getElementById('bookingsList'));
            return infoEl;
        }

        function showAllBookings() {
            document.getElementById('customerSearch').value = '';
            filteredBookings = [...allBookings];
            displayBookings(allBookings);
            updateStatistics(allBookings);
            
            // Remove search info
            const searchInfo = document.querySelector('.search-info');
            if (searchInfo) {
                searchInfo.remove();
            }
        }

        function refreshBookings() {
            loadBookings();
        }

        // Show booking details modal
        async function showBookingDetails(bookingId) {
            try {
                const response = await fetch(`/api/bookings/${bookingId}`);
                if (!response.ok) {
                    throw new Error('Failed to load booking details');
                }
                
                const booking = await response.json();
                currentBookingForModal = booking;
                
                const modalBody = document.getElementById('modalBody');
                modalBody.innerHTML = `
                    <div class="booking-detail-content">
                        <div class="detail-section">
                            <h4><i class="fas fa-info-circle"></i> Booking Information</h4>
                            <div class="detail-grid">
                                <div class="detail-row">
                                    <label>Booking ID:</label>
                                    <span>#${booking.id}</span>
                                </div>
                                <div class="detail-row">
                                    <label>Customer Name:</label>
                                    <span>${escapeHtml(booking.customerName || 'Unknown')}</span>
                                </div>
                                <div class="detail-row">
                                    <label>Status:</label>
                                    <span class="status-badge confirmed">Confirmed</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-film"></i> Movie & Show Details</h4>
                            <div class="detail-grid">
                                <div class="detail-row">
                                    <label>Movie Title:</label>
                                    <span>${escapeHtml(booking.movieTitle || 'Unknown Movie')}</span>
                                </div>
                                <div class="detail-row">
                                    <label>Show Time:</label>
                                    <span>${escapeHtml(booking.showTime || 'Not specified')}</span>
                                </div>
                                <div class="detail-row">
                                    <label>Show ID:</label>
                                    <span>#${booking.showId || 'N/A'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-couch"></i> Seat Information</h4>
                            <div class="detail-grid">
                                <div class="detail-row">
                                    <label>Selected Seats:</label>
                                    <span class="seat-list">
                                        ${booking.seats && booking.seats.length > 0 ? 
                                            booking.seats.map(seat => `<span class="seat-number">${seat}</span>`).join(' ') :
                                            'No seats specified'
                                        }
                                    </span>
                                </div>
                                <div class="detail-row">
                                    <label>Number of Tickets:</label>
                                    <span>${booking.seats ? booking.seats.length : 0}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="detail-section">
                            <h4><i class="fas fa-dollar-sign"></i> Payment Details</h4>
                            <div class="detail-grid">
                                <div class="detail-row">
                                    <label>Price per Ticket:</label>
                                    <span>‚Çπ500.00</span>
                                </div>
                                <div class="detail-row">
                                    <label>Number of Tickets:</label>
                                    <span>${booking.seats ? booking.seats.length : 0}</span>
                                </div>
                                <div class="detail-row total-row">
                                    <label><strong>Total Amount:</strong></label>
                                    <span class="total-amount"><strong>$${(booking.totalPrice || 0).toFixed(2)}</strong></span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                
                document.getElementById('bookingModal').style.display = 'flex';
                
            } catch (error) {
                console.error('Error loading booking details:', error);
                showNotification('Failed to load booking details', 'error');
            }
        }

        function closeModal() {
            document.getElementById('bookingModal').style.display = 'none';
            currentBookingForModal = null;
        }

        function printBooking() {
            if (!currentBookingForModal) return;
            
            const printContent = `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; padding: 20px;">
                    <div style="text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px;">
                        <h1 style="color: #e50914; margin: 0;">üé¨ Movie Ticket</h1>
                        <h2 style="color: #333; margin: 10px 0;">Booking Confirmation</h2>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e50914;">Booking Information</h3>
                        <p><strong>Booking ID:</strong> #${currentBookingForModal.id}</p>
                        <p><strong>Customer:</strong> ${escapeHtml(currentBookingForModal.customerName || 'Unknown')}</p>
                        <p><strong>Status:</strong> Confirmed</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e50914;">Movie Details</h3>
                        <p><strong>Movie:</strong> ${escapeHtml(currentBookingForModal.movieTitle || 'Unknown Movie')}</p>
                        <p><strong>Show Time:</strong> ${escapeHtml(currentBookingForModal.showTime || 'Not specified')}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h3 style="color: #e50914;">Seat Information</h3>
                        <p><strong>Seats:</strong> ${currentBookingForModal.seats ? currentBookingForModal.seats.join(', ') : 'No seats specified'}</p>
                        <p><strong>Number of Tickets:</strong> ${currentBookingForModal.seats ? currentBookingForModal.seats.length : 0}</p>
                    </div>
                    
                    <div style="margin-bottom: 20px; border-top: 2px solid #333; padding-top: 20px;">
                        <h3 style="color: #e50914;">Payment Summary</h3>
                        <p><strong>Total Amount:</strong> $${(currentBookingForModal.totalPrice || 0).toFixed(2)}</p>
                    </div>
                    
                    <div style="text-align: center; margin-top: 30px; font-size: 12px; color: #666;">
                        <p>Thank you for choosing our Movie Ticket Booking System!</p>
                        <p>Please present this ticket at the theater entrance.</p>
                    </div>
                </div>
            `;
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write(`
                <html>
                    <head><title>Movie Ticket - Booking #${currentBookingForModal.id}</title></head>
                    <body onload="window.print(); window.close();">
                        ${printContent}
                    </body>
                </html>
            `);
            printWindow.document.close();
        }

        // Update statistics
        function updateStatistics(bookings) {
            const totalBookings = bookings.length;
            const totalSeats = bookings.reduce((sum, booking) => 
                sum + (booking.seats ? booking.seats.length : 0), 0);
            const totalSpent = bookings.reduce((sum, booking) => 
                sum + (booking.totalPrice || 0), 0);
            const uniqueMovies = new Set(bookings.map(booking => 
                booking.movieTitle || 'Unknown')).size;

            document.getElementById('totalBookings').textContent = totalBookings;
            document.getElementById('totalSeats').textContent = totalSeats;
            document.getElementById('totalSpent').textContent = `$${totalSpent.toFixed(2)}`;
            document.getElementById('uniqueMovies').textContent = uniqueMovies;
            
            if (totalBookings > 0) {
                document.getElementById('statisticsSection').style.display = 'block';
            }
        }

        // Export bookings
        function exportBookings() {
            if (allBookings.length === 0) {
                showNotification('No bookings to export', 'info');
                return;
            }
            
            const csvContent = generateCSV(allBookings);
            downloadCSV(csvContent, 'movie_bookings.csv');
            showNotification('Bookings exported successfully!', 'success');
        }

        function generateCSV(bookings) {
            const headers = ['Booking ID', 'Customer Name', 'Movie Title', 'Show Time', 'Seats', 'Total Price'];
            const csvRows = [headers.join(',')];
            
            bookings.forEach(booking => {
                const row = [
                    booking.id || '',
                    `"${(booking.customerName || '').replace(/"/g, '""')}"`,
                    `"${(booking.movieTitle || '').replace(/"/g, '""')}"`,
                    `"${(booking.showTime || '').replace(/"/g, '""')}"`,
                    `"${booking.seats ? booking.seats.join(', ') : ''}"`,
                    (booking.totalPrice || 0).toFixed(2)
                ];
                csvRows.push(row.join(','));
            });
            
            return csvRows.join('\n');
        }

        function downloadCSV(content, filename) {
            const blob = new Blob([content], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }

        // State management
        function showLoadingState() {
            document.getElementById('loadingState').style.display = 'block';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('bookingsList').style.display = 'none';
            document.getElementById('statisticsSection').style.display = 'none';
        }

        function showEmptyState() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'block';
            document.getElementById('bookingsList').style.display = 'none';
            document.getElementById('statisticsSection').style.display = 'none';
        }

        function showBookingsList() {
            document.getElementById('loadingState').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('bookingsList').style.display = 'block';
        }

        function showErrorState(message) {
            document.getElementById('loadingState').innerHTML = `
                <div class="error-state">
                    <i class="fas fa-exclamation-triangle"></i>
                    <h3>Error Loading Bookings</h3>
                    <p>${message}</p>
                    <button class="btn btn-primary" onclick="loadBookings()">
                        <i class="fas fa-retry"></i> Try Again
                    </button>
                </div>
            `;
        }

        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape' && document.getElementById('bookingModal').style.display === 'flex') {
                closeModal();
            }
            if (e.ctrlKey && e.key === 'f') {
                e.preventDefault();
                document.getElementById('customerSearch').focus();
            }
        });

        // Auto-search as you type
        document.getElementById('customerSearch').addEventListener('input', function(e) {
            // Debounce the search
            clearTimeout(window.searchTimeout);
            window.searchTimeout = setTimeout(() => {
                searchBookings();
            }, 300);
        });
    </script>
</body>
</html>